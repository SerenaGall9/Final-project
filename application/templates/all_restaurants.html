{% extends "layout2.html" %}

{% block body_content %}

<div class="container mt-4">
  <h1 class="mb-4">Explore Restaurants</h1>

  <!-- Filter bar -->

  <form method="get" action="{{ url_for('all_restaurants') }}" class="row g-3 mb-4 bg-white p-4 rounded shadow-sm">
    <div class="col-md-3 d-flex justify-content-center">
      <!-- Cuisine Filter -->
      <div class="w-100">
        <label for="cuisine" class="form-label">Cuisine</label>
        <select class="form-select" name="cuisine" id="cuisine">
          <option value="">All</option>
          {% for c in cuisines %}
            <option value="{{ c.cuisine_id }}" {% if selected_cuisine == c.cuisine_id %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="col-md-3 d-flex justify-content-center">
      <!-- Location Filter -->
      <div class="w-100">
        <label for="location" class="form-label">Location</label>
        <select class="form-select" name="location" id="location">
          <option value="">All</option>
          {% for l in locations %}
            <option value="{{ l.location_id }}" {% if selected_location == l.location_id %}selected{% endif %}>{{ l.direction }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Button to open the additional filters modal -->
    <div class="col-md-3 d-flex justify-content-center">
      <button class="btn btn-outline-secondary w-100" type="button" data-bs-toggle="offcanvas" data-bs-target="#additionalFiltersModal" aria-controls="additionalFiltersModal">
        Filter by
      </button>
    </div>

    <!-- Submit Button -->
    <div class="col-md-3 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
    </div>
  </form>

  <!-- Offcanvas for Additional Filters -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="additionalFiltersModal" aria-labelledby="additionalFiltersModalLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="additionalFiltersModalLabel">Additional Filters</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <!-- Additional Filters Form -->
      <form method="get" action="{{ url_for('all_restaurants') }}">
        <!-- Price Range Filter -->
        <div class="mb-3">
          <label for="price_range" class="form-label">Price Range</label>
          <select class="form-select" name="price_range" id="price_range">
            <option value="">All</option>
            {% for i in range(1, 5) %}
              <option value="{{ i }}" {% if selected_price_range == i %}selected{% endif %}>{{ "Â£" * i }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Rating Filter -->
        <div class="mb-3">
          <label for="rating" class="form-label">Min Avg Rating</label>
          <select class="form-select" name="rating" id="rating">
            <option value="">Any</option>
            {% for i in range(5, 0, -1) %}
              <option value="{{ i }}" {% if selected_rating and selected_rating == i %}selected{% endif %}>{{ i }}+</option>
            {% endfor %}
          </select>
        </div>

        <!-- Ambiance Filter -->
        <div class="mb-3">
          <label for="ambiance" class="form-label">Min Ambiance</label>
          <select class="form-select" name="ambiance" id="ambiance">
            <option value="">Any</option>
            {% for i in range(5, 0, -1) %}
              <option value="{{ i }}" {% if selected_ambiance and selected_ambiance == i %}selected{% endif %}>{{ i }}+</option>
            {% endfor %}
          </select>
        </div>

        <!-- Service Filter -->
        <div class="mb-3">
          <label for="service" class="form-label">Min Service</label>
          <select class="form-select" name="service" id="service">
            <option value="">Any</option>
            {% for i in range(5, 0, -1) %}
              <option value="{{ i }}" {% if selected_service and selected_service == i %}selected{% endif %}>{{ i }}+</option>
            {% endfor %}
          </select>
        </div>

        <!-- Value Filter -->
        <div class="mb-3">
          <label for="value" class="form-label">Min Value</label>
          <select class="form-select" name="value" id="value">
            <option value="">Any</option>
            {% for i in range(5, 0, -1) %}
              <option value="{{ i }}" {% if selected_value and selected_value == i %}selected{% endif %}>{{ i }}+</option>
            {% endfor %}
          </select>
        </div>

        <!-- Location Rating Filter -->
        <div class="mb-3">
          <label for="location_rating" class="form-label">Min Location Rating</label>
          <select class="form-select" name="location_rating" id="location_rating">
            <option value="">Any</option>
            {% for i in range(5, 0, -1) %}
              <option value="{{ i }}" {% if selected_location_rating and selected_location_rating == i %}selected{% endif %}>{{ i }}+</option>
            {% endfor %}
          </select>
        </div>

        <!-- Submit Button inside Modal -->
        <button type="submit" class="btn btn-primary">Apply Filters</button>
      </form>
    </div>
  </div>

  <!-- Restaurant list -->
  {% if restaurants %}
    {% for r in restaurants %}
      <div class="row restaurant-card p-3 mb-4 bg-white rounded shadow-sm">
        <div class="col-md-8">
          <h4><a href="{{ url_for('get_restaurant', id=r.restaurant_id) }}">{{ r.name }}</a></h4>
          <p><strong>Cuisine:</strong> {{ r.cuisine }}</p>
          <p><strong>Vibe:</strong> {{ r.vibe }}</p>
          <p><strong>Location:</strong> {{ r.location }}</p>
          <p><strong>Price range:</strong> {{ r.price_range }}</p>
          <p><strong>Rating:</strong> {% if r.avg_rating is not none %}{{ r.avg_rating | round(1) }}{% else %}No reviews yet{% endif %}</p>
          <a href="{{ r.website }}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">Visit Website</a>
        </div>
        <div class="col-md-4">
          <img src="{{ url_for('static', filename='restaurant_images/default.jpg') }}" alt="{{ r.name }}" class="img-fluid rounded">
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-info mt-4">No restaurants match your criteria.</div>
  {% endif %}
</div>

{% endblock %}

<script>
  // Ensure the modal submit works
  document.querySelector('#additionalFiltersModal').addEventListener('hidden.bs.offcanvas', function () {
    var form = document.querySelector('#additionalFiltersModal form');
    if (form) {
      form.submit();
    }
  });
</script>


