{% extends "layout2.html" %}

{% block body_content %}

<div class="container mt-4">
  <h1 class="mb-4">Explore Restaurants</h1>

  <!-- Filter bar -->
 <!-- Filter Bar -->
<form method="get" action="{{ url_for('all_restaurants') }}" class="filter-bar p-4 rounded shadow-sm text-center">

  <div class="row justify-content-center mb-4">
    <!-- Cuisine -->
    <div class="col-md-3 mb-3">
      <label for="cuisine" class="form-label">Cuisine</label>
      <select class="form-select" name="cuisine" id="cuisine">
        <option value="">All</option>
        {% for c in cuisines %}
          <option value="{{ c.cuisine_id }}" {% if selected_cuisine == c.cuisine_id %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Vibe -->
    <div class="col-md-3 mb-3">
      <label for="vibe" class="form-label">Vibe</label>
      <select class="form-select" name="vibe" id="vibe">
        <option value="">All</option>
        {% for v in vibes %}
          <option value="{{ v.vibe_id }}" {% if selected_vibe == v.vibe_id %}selected{% endif %}>{{ v.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Location -->
    <div class="col-md-3 mb-3">
      <label for="location" class="form-label">Location</label>
      <select class="form-select" name="location" id="location">
        <option value="">All</option>
        {% for l in locations %}
          <option value="{{ l.location_id }}" {% if selected_location == l.location_id %}selected{% endif %}>{{ l.direction }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- Sort By + Filter By Buttons -->
  <div class="row justify-content-center mb-4">
    <div class="col-md-3 mb-3">
      <select class="form-select" name="sort" id="sort">
        <option value="">Sort By</option>
        <option value="top5" {% if sort_option == 'top5' %}selected{% endif %}>Our Top Five</option>
        <option value="bottom5" {% if sort_option == 'bottom5' %}selected{% endif %}>Our Worst Five</option>
      </select>
    </div>

    <div class="col-md-3 mb-3">
      <button class="btn btn-outline-secondary w-100" type="button" data-bs-toggle="offcanvas" data-bs-target="#additionalFiltersModal" aria-controls="additionalFiltersModal">
        Filter by
      </button>
    </div>
  </div>

  <!-- Apply Filters Button -->
  <div class="row justify-content-center">
    <div class="col-md-6">
      <button type="submit" class="btn btn-primary btn-lg w-100">Apply Filters</button>
    </div>
  </div>
</form>


  <!-- Offcanvas for Additional Filters -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="additionalFiltersModal" aria-labelledby="additionalFiltersModalLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="additionalFiltersModalLabel">Additional Filters</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <!-- Additional Filters Form -->
      <form method="get" action="{{ url_for('all_restaurants') }}">
        <!-- Hidden sort input to preserve sort option -->
        <input type="hidden" name="sort" value="{{ sort_option }}">

        <!-- Price Range Filter -->
        <div class="mb-3">
          <label for="price_range" class="form-label">Price Range</label>
          <select class="form-select" name="price_range" id="price_range">
            <option value="">All</option>
            {% for i in range(1, 5) %}
              <option value="{{ i }}" {% if selected_price_range == i %}selected{% endif %}>{{ "Â£" * i }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Rating Filter -->
        <div class="mb-3">
          <label for="rating" class="form-label">Overall Rating</label>
          <select class="form-select" name="rating" id="rating">
            <option value="">Any</option>
            {% for i in range(5, 0, -1) %}
              <option value="{{ i }}" {% if selected_rating and selected_rating == i %}selected{% endif %}>{{ i }}+</option>
            {% endfor %}
          </select>
        </div>

        <!-- Ambiance Filter -->
        <div class="mb-3">
          <label for="ambiance" class="form-label">Ambiance</label>
          <select class="form-select" name="ambiance" id="ambiance">
            <option value="">Any</option>
            {% for i in range(5, 0, -1) %}
              <option value="{{ i }}" {% if selected_ambiance and selected_ambiance == i %}selected{% endif %}>{{ i }}+</option>
            {% endfor %}
          </select>
        </div>

        <!-- Service Filter -->
        <div class="mb-3">
          <label for="service" class="form-label">Service</label>
          <select class="form-select" name="service" id="service">
            <option value="">Any</option>
            {% for i in range(5, 0, -1) %}
              <option value="{{ i }}" {% if selected_service and selected_service == i %}selected{% endif %}>{{ i }}+</option>
            {% endfor %}
          </select>
        </div>

        <!-- Value Filter -->
        <div class="mb-3">
          <label for="value" class="form-label">Value</label>
          <select class="form-select" name="value" id="value">
            <option value="">Any</option>
            {% for i in range(5, 0, -1) %}
              <option value="{{ i }}" {% if selected_value and selected_value == i %}selected{% endif %}>{{ i }}+</option>
            {% endfor %}
          </select>
        </div>

        <button type="submit" class="btn btn-primary">Apply Filters</button>
      </form>
    </div>
  </div>

  <!-- Restaurant list -->
  {% if restaurants %}
    {% for r in restaurants %}
    <a href="{{ url_for('get_restaurant', id=r.restaurant_id) }}" class="restaurant-card-link">
  <div class="restaurant-card custom-card" style="background-image: url('{{ url_for('static', filename='restaurant_images/' ~ r.restaurant_id ~ '/banner.jpg') }}');">
    <div class="card-overlay">
      <h3>{{ r.name }}</h3>
      <div class="card-details">
        <p><strong>Rating:</strong> {% if r.avg_rating is not none %}{{ r.avg_rating | round(1) }}{% else %}No reviews yet{% endif %}</p>
        <p><strong>Cuisine:</strong> {{ r.cuisine }}</p>
        <p><strong>Vibe:</strong> {{ r.vibe }}</p>
        <p><strong>Location:</strong> {{ r.location }}</p>
        <p><strong>Price range:</strong> {{ r.price_range }}</p>
      </div>
    </div>
  </div>
</a>
    {% endfor %}
  {% else %}
    <div class="alert alert-info mt-4">No restaurants match your criteria.</div>
  {% endif %}
</div>

{% endblock %}

<script>
  // Auto-submit Sort By dropdown
  document.getElementById('sort').addEventListener('change', function () {
    this.form.submit();
  });

  // Ensure the modal submit works
  document.querySfelector('#additionalFiltersModal').addEventListener('hidden.bs.offcanvas', function () {
    var form = document.querySelector('#additionalFiltersModal form');
    if (form) {
      form.submit();
    }
  });
</script>
